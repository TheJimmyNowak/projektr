---
title: "analiza"
author: "Miko≈Çaj Data"
date: "2024-05-20"
output: html_document
---

```{r}
#install.packages("knitr")
#install.packages("treemap")
#install.packages("readr")
#install.packages("tidyverse")
#install.packages("readr")
#install.packages('cluster')
#install.packages('factoextra')
#install.packages('randomForest')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read the data
Data source: https://www.kaggle.com/datasets/teejmahal20/airline-passenger-satisfaction

```{r}
library(readr)
dat <- read_csv("train.csv")
dat <- dat[,-2:0]
dat <- na.omit(dat)
dat
```
# Prepare data and visualize
In case of you wondering this is source of charts ideas:
https://r-graph-gallery.com/index.html


```{r}
library("RColorBrewer")
library("ggplot2")

dat$Gender <- as.factor(dat$Gender)
coul <- brewer.pal(6, "Set2") 
barplot(summary(dat$Gender), col=coul)
```

```{r}
dat$`Customer Type` <-as.factor(dat$`Customer Type`)
barplot(summary(dat$`Customer Type`), col=coul)
```

```{r}
dat$satisfaction <- as.factor(dat$satisfaction)
barplot(summary(dat$satisfaction), col=coul)
```

```{r}
library(treemap)
dat$Class <- as.factor(dat$Class)

values <- c(sum(dat$Class == "Eco"), 
            sum(dat$Class == "Eco Plus"), 
            sum(dat$Class == "Business"))

groups <- c("Eco", "Eco Plus", "Business")
df <- data.frame(groups, values)
treemap(df, index="groups",
        vSize="values", type="index")
```

```{r}
library(dplyr)
colnames(dat)
names<-c("Inflight wifi service", "Ease of Online booking", "Food and drink", "Seat comfort",
         "On-board service", "Baggage handling", "Departure Delay in Minutes",
         "Departure/Arrival time convenient", "Gate location", "Online boarding",
         "Inflight entertainment", "Leg room service", "Checkin service",
         "Arrival Delay in Minutes")

lapply(dat[names] %>% na.omit(), mean)
```

```{r}
dat$`Type of Travel` <- as.factor(dat$`Type of Travel`)
barplot(summary(dat$`Type of Travel`), col=coul)
```

# Plot some correlations
```{r}
plot(dat[1:200,(ncol(dat)-5):ncol(dat)-1], cex=0.5)
```
```{r}
heatmap(as.matrix(dat[1:100,(ncol(dat)-16):ncol(dat)-1]),Colv = NA, Rowv = NA, scale="column")
```
# Let's try to divide a satisfaction label on 3 items "dissatisfied", "neutral" and "satisfied"
```{r}
df <- dat[, -(1:6)]
df <-df[,1:16]
df <- scale(df)
km.out <- kmeans(df, centers=3)
clustered <- cbind(dat, cluster=km.out$cluster)
```

Evaluate results
```{r}
library(purrr)
satisfied <-  sum(clustered$satisfaction == "satisfied")
dissatisfied_or_neutral <- sum(clustered$satisfaction == "neutral or dissatisfied")
satisfied_clustered_properly <- sum(clustered$satisfaction == "satisfied" 
                                    & clustered$cluster == 1)
dissatisfied_clustered_properly <- sum(clustered$satisfaction == "neutral or dissatisfied" 
                                       & clustered$cluster == 3)
neutral_clustered_properly <- sum(clustered$satisfaction == "neutral or dissatisfied" & clustered$cluster == 2)

print(paste("Satisfied clustered properly: ", satisfied_clustered_properly/satisfied))
print(paste("Dissatisfied neutral", (dissatisfied_clustered_properly
+neutral_clustered_properly)/dissatisfied_or_neutral))
```
Results: Disapointed but not surprised :( clustering in this way is a little bit too random.

```{r}
clustered$cluster[clustered$satisfaction == "satisfied" & clustered$cluster > 1] <- 1
clustered$cluster[clustered$satisfaction == "neutral or dissatisfied" & clustered$cluster == 1] <- 2
clustered <- clustered[, -which(names(clustered) == "satisfaction")]
```

```{r}
clustered$cluster <- as.factor(clustered$cluster)
barplot(summary(clustered$cluster), col=coul)
```
# Diffrent aproach to the problem
https://letsdatascience.com/binning/
```{r}
df <- dat[, -(1:6)]
df <-df[,1:14]
df_with_means <- cbind(dat, rank_mean=apply(df, 1, mean))
df_with_means
```
In this point we can see that passanger with higher mean are most likely to be satisfied :)
Calculate this ;)
```{r}
print(mean(df_with_means[df_with_means$satisfaction=="satisfied",]$rank_mean))
print(mean(df_with_means[df_with_means$satisfaction=="neutral or dissatisfied",]$rank_mean))
```
```{r}
library(dplyr)
clustered <- df_with_means %>% mutate(cluster = cut(rank_mean, breaks=c(0, 2, 3.2, 5), labels=c("dissatisfied", "neutral", "satisfied")))
clustered
```
Evaluate results
```{r}
library(purrr)
satisfied <-  sum(clustered$satisfaction == "satisfied")
dissatisfied_or_neutral <- sum(clustered$satisfaction == "neutral or dissatisfied")

satisfied_clustered_properly <- sum(clustered$satisfaction == "satisfied" 
                                    & clustered$cluster == "satisfied")
dissatisfied_clustered_properly <- sum(clustered$satisfaction == "neutral or dissatisfied" 
                                       & clustered$cluster == "dissatisfied")
neutral_clustered_properly <- sum(clustered$satisfaction == "neutral or dissatisfied" & clustered$cluster == "neutral")

print(paste("Satisfied clustered properly: ", satisfied_clustered_properly/satisfied))
print(paste("Dissatisfied neutral", (dissatisfied_clustered_properly
+neutral_clustered_properly)/dissatisfied_or_neutral))
```
```{r}
clustered$cluster[clustered$satisfaction == "satisfied" & clustered$cluster != "satisfied"] <- "satisfied"
clustered$cluster[clustered$satisfaction == "neutral or dissatisfied" & clustered$cluster == "satisfied"] <- NA
```

```{r}
clustered$cluster <- as.factor(clustered$cluster)
barplot(summary(clustered$cluster), col=coul)
```
Results: Besides grades from pasangers there are two factors that corelates with satisfaction arrival delay and departure delay
```{r}
library(ggplot2)
library(dplyr)

data <- read.csv("train.csv")

summary_data <- data %>%
  group_by(Gender, Customer.Type) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

ggplot(summary_data, aes(x = Gender, y = Count, fill = Customer.Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5) +
  labs(title = "Number of Loyal and Disloyal Customers by Gender",
       x = "Gender", y = "Number of Customers") +
  theme_minimal()

```
```{r}
summary_data <- data %>%
  group_by(Type.of.Travel, satisfaction) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)

ggplot(summary_data, aes(x = Type.of.Travel, y = Count, fill = satisfaction)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5) +
  labs(title = "Passenger Satisfaction Based on Type of Travel",
       x = "Type of Travel", y = "Number of Passengers",
       fill = "Satisfaction") +
  theme_minimal()
```

```{r}

ggplot(clustered, aes(x = clustered$`Arrival Delay in Minutes`, y = clustered$`Departure Delay in Minutes`)) +
  geom_hex(
    colour = "#00FFF7",
    alpha = 0.8,
    linewidth = 0.2,
    bins = 60,
    )+
  labs(
    x = "Arrival delay time",
    y = "Departure delay time"
  )


```


```{r}
dat2 <- read.csv("train.csv")  

business_data <- subset(dat2, dat2$Type.of.Travel == "Business travel")

personal_data <- subset(dat2, dat2$Type.of.Travel == "Personal Travel")

business_avg <- colMeans(business_data[, c(9:21)])

personal_avg <- colMeans(personal_data[, c(9:21)])

avg_data <- data.frame(Category = names(business_avg),
                       Business_Travel = business_avg,
                       Personal_Travel = personal_avg)

library(ggplot2)
library(reshape2)

avg_data_long <- melt(avg_data, id.vars = "Category")

ggplot(avg_data_long, aes(x = Category, y = value, group = variable, color = variable)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(title = "Comparison of ratings for business and private trips",
       y = "Average rating",
       color = "Type of travel") +
  coord_polar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}

library(ggplot2)
library(reshape2)

dat2 <- read.csv("train.csv")  

business_data <- subset(dat2, dat2$Type.of.Travel == "Business travel")
personal_data <- subset(dat2, dat2$Type.of.Travel == "Personal Travel")


business_avg <- colMeans(business_data[, c(9:21)])
personal_avg <- colMeans(personal_data[, c(9:21)])

avg_data <- data.frame(Category = names(business_avg),
                       Business_Travel = business_avg,
                       Personal_Travel = personal_avg)

abbreviate_category <- function(category) {
  parts <- unlist(strsplit(category, "\\."))
  abbreviated_parts <- substr(parts, 1, 1)
  paste(abbreviated_parts, collapse = ".")
}

avg_data$Category <- sapply(avg_data$Category, abbreviate_category)


avg_data_long <- melt(avg_data, id.vars = "Category")


ggplot(avg_data_long, aes(x = Category, y = value, group = variable, color = variable)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  theme_minimal() +
  labs(title = "Comparison of ratings for business and private trips",
       y = "Average rating",
       color = "Type of travel") +
  coord_polar() +
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    legend.position = "bottom",
    legend.box.margin = margin(t = 10, b = 10),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  scale_color_manual(values = c("Business_Travel" = "red", "Personal_Travel" = "blue"))

```